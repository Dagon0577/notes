# 学习内容 2019-07-08
- [两阶段提交是什么；分布式事务协调者是什么；分布式事务的应用场景和作用。](#两阶段提交、分布式事务)
---
## [两阶段提交、分布式事务](https://blog.csdn.net/sofia1217/article/details/53968177)
### CAP
- CAP理论：一个分布式系统中不可能同时满足一致性(Consistency)、可用性(Availability),以及分区容错性(Partition tolerance)
    - `一致性`: 在分布式系统中数据往往存在多个副本，一致性描述的是这些副本中的数据在内容和组织上的一致。
    - `可用性`:可用性描述了系统对用户的服务能力，每次请求都能获取到非错的响应——但是不保证获取的数据为最新数据。
    - `分区容错性`:分布式系统通常由多个节点构成，这些节点通常分布在不同的网络中，然而网络始终是不可靠的，所以存在分布式集群中的节点因为网络通信故障导致被孤立成一个个小集群的可能性，分区容错性要求在出现这种情况下系统仍然能够对外提供一致性的可用服务。（以实际效果而言，分区相当于对通信的时限要求。系统如果不能在时限内达成数据一致性，就意味着发生了分区的情况，必须就当前操作在C和A之间做出选择）

  对于一个分布式系统，我们始终要假设网络是不可靠的，所以分区容错性是对一个分布式系统最基本的要求，所以我们更多的是尝试在可用性和一致性之 间寻找一个平衡点。让分布式集群始终对外提供可用的一致性服务一直是富有挑战和趣味的一项任务。暂且抛开可用性，拿一致性来说，对于关系型数据库我们通常 利用事务来保证数据的一致性，当我们的数据量越来越大，大到单库已经无法承担时，我们不得不采取分库分表的策略对数据库实现拆分，构建分布式数据库集群， 这样可以将一个数据库的压力分摊到多个数据库，极大的提升了数据库的存储和响应能力，但是也为我们使用数据库带来了许多的限制，比如主键的全局唯一、联表 查询、数据聚合等等，另外一个相当棘手的问题就是数据库的事务由原先的单库事务变成了现在的分布式事务。
---
### 两阶段提交协议（2PC：Two-Phrase Commit）
- `两阶段提交协议`：两阶段提交协议的目标在于在分布式系统中保证数据的一致性，许多分布式系统采用该协议提供对分布式事务的支持。顾名思义，该协议将一个分布式的事务过程拆分成两个阶段：投票阶段和事务提交阶段。为了让整个数据库集群能够正常的运行，该协议指定了一个“协调者”单点，用于协调整个数据库集群的运行，为了简化描述，我们将数据库里面的各个节点称为“参与者”，三阶段提交协议中同样包含“协调者”和“参与者”这两个定义。

#### **`第一阶段：投票阶段`**
该阶段的主要目的在于打探数据库集群中的各个参与者是否能够正常的执行事务，具体步骤如下：  

1. 所有的参与者回复能够正常执行事务
2. 一个或多个参与者回复事务执行失败
3. 协调者等待超时。


#### **`第二阶段：事务提交阶段`**
在第一阶段协调者的询盘之后，各个参与者会回复自己事务的执行情况，这时候存在三种可能：

1. 所有的参与者回复能够正常执行事务
2. 一个或多个参与者回复事务执行失败
3. 协调者等待超时。

对于第一种情况，协调者将向所有的参与者发出提交事务的通知，具体步骤如下：

1. 协调者向各个参与者发送commit通知，请求提交事务。
2. 参与者收到事务提交通知之后，执行commit操作，然后释放占有的资源。
3. 参与者向协调者返回事务commit结果信息。

对于第二、三种情况，协调者均认为参与者无法正常成功执行事务，为了整个集群数据的一致性，所以要向各个参与者发送事务回滚通知，具体步骤如下：

1. 协调者向各个参与者发送事务rollback通知，请求回滚事务。
2. 参与者收到事务回滚通知之后，执行rollback操作，然后释放占有的资源。
3. 参与者向协调者返回事务rollback结果信息。


两阶段提交协议解决的是分布式数据库数据强一致性问题，其原理简单，易于实现，但是缺点也是显而易见的，主要缺点如下：

- 单点问题：  
协调者在整个两阶段提交过程中扮演着举足轻重的作用，一旦协调者所在服务器宕机，那么就会影响整个数据库集群的正常运行，比如在第二阶段中，如果协调者因为故障不能正常发送事务提交或回滚通知，那么参与者们将一直处于阻塞状态，整个数据库集群将无法提供服务。

- 同步阻塞：  
两阶段提交执行过程中，所有的参与者都需要听从协调者的统一调度，期间处于阻塞状态而不能从事其他操作，这样效率及其低下。

- 数据不一致性：  
两阶段提交协议虽然为分布式数据强一致性所设计，但仍然存在数据不一致性的可能，比如在第二阶段中，假设协调者发出了 事务commit的通知，但是因为网络问题该通知仅被一部分参与者所收到并执行了commit操作，其余的参与者则因为没有收到通知一直处于阻塞状态，这 时候就产生了数据的不一致性。
---
### [分布式事务的应用场景和作用](https://juejin.im/post/5a9cb1bf6fb9a028c06a4f6b)